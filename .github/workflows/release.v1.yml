name: Build and Release v1

on:
    workflow_dispatch:
        inputs:
            tag:
                description: "版本号 (例如: v2.7.0)"
                required: true
                default: "v2.7.0"
            release_body:
                description: "更新日志"
                required: false
                default: "Manual Build"

env:
    PYTHON_VERSION: "3.13" # 必须是 3.13
    IS_MANUAL: ${{ github.event_name == 'workflow_dispatch' }}

jobs:
    init-matrix:
        runs-on: ubuntu-latest
        outputs:
            matrix: ${{ steps.set-matrix.outputs.matrix }}
        steps:
            - name: Set matrix
              id: set-matrix
              run: |
                  # 移除了过时的 macos-13，统一使用最新镜像
                  matrix='matrix=[
                    {"build": "windows", "os": "windows-latest", "arch": "x86_64"},
                    {"build": "macos", "os": "macos-latest", "arch": "aarch64"}
                  ]'
                  echo $matrix >> $GITHUB_OUTPUT

    build-app:
        needs: init-matrix
        runs-on: ${{ matrix.os }}
        permissions:
          contents: write
        strategy:
            fail-fast: false
            matrix:
                include: ${{fromJson(needs.init-matrix.outputs.matrix)}}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: 'pip'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  # 根据系统选择依赖文件
                  if [ "${{ matrix.build }}" = "macos" ]; then
                    pip install -r requirements-mac.txt
                  else
                    pip install -r requirements.txt
                  fi
              shell: bash

            - name: Build App
              run: |
                if [ "${{ matrix.build }}" = "windows" ]; then
                  # Windows 下运行构建脚本
                  bash scripts/build-action
                else
                  # macOS 下运行构建脚本
                  bash scripts/build-macos.sh --create-dmg --version "${{ github.event.inputs.tag }}"
                fi
              shell: bash

            - name: Create Release
              uses: svenstaro/upload-release-action@v2
              with:
                  repo_token: ${{ secrets.GITHUB_TOKEN }}
                  file: dist/MDCx* # 自动匹配生成的文件
                  tag: ${{ github.event.inputs.tag }}
                  overwrite: true
                  file_glob: true
                  body: ${{ github.event.inputs.release_body }}

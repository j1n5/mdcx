name: Build and Release v1

on:
    workflow_dispatch:
        inputs:
            tag:
                description: "版本号"
                required: true
                default: "v2.7.0"

jobs:
    build-windows:
        runs-on: windows-latest
        permissions:
          contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                fetch-depth: 0

            - name: Debug - List Files
              run: |
                echo "Current Directory: $(pwd)"
                echo "Listing files in root:"
                ls -R
              shell: bash

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.13'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  # 强制查找 requirements.txt 并在其所在目录运行
                  REQ_PATH=$(find . -name "requirements.txt" | head -n 1)
                  if [ -f "$REQ_PATH" ]; then
                    echo "Found requirements at $REQ_PATH"
                    pip install -r "$REQ_PATH"
                  else
                    echo "ERROR: requirements.txt not found anywhere in the repo!"
                    exit 1
                  fi
                  pip install pyinstaller
              shell: bash

            - name: Build Windows App
              run: |
                # 寻找构建脚本或尝试直接打包
                if [ -f "scripts/build-action" ]; then
                  bash scripts/build-action
                else
                  pyinstaller --noconfirm --onefile --console --name "MDCx" main.py
                fi
              shell: bash

            - name: Create Release
              uses: svenstaro/upload-release-action@v2
              with:
                  repo_token: ${{ secrets.GITHUB_TOKEN }}
                  file: dist/*.exe
                  tag: ${{ github.event.inputs.tag }}
                  overwrite: true
                  file_glob: true
